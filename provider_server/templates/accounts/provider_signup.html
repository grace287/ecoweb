{% load static %}

<link rel="stylesheet" href="{% static 'css/accounts/signup.css' %}">

{% block content %}


<div class="signup-container">
    <h1>ëŒ€í–‰ì‚¬ íšŒì› ê°€ì…</h1>

    {% if error %}
    <script>
        window.onload = function() {
            showAlert("{{ error }}");
        }
    </script>
    {% endif %}

    <form method="post" class="signup-form" enctype="multipart/form-data" action="{% url 'provider_signup' %}">
        {% csrf_token %}

        <div class="form-section">
            <h2>ê¸°ë³¸ ì •ë³´</h2>

            <div class="form-group">
                <label for="username">ì•„ì´ë””</label>
                <div class="input-with-button">
                    <input type="text" id="username" name="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                    <button type="button" class="btn-verify" onclick="checkIdDuplicate()">ì¤‘ë³µí™•ì¸</button>
                </div>
            </div>

            <div class="form-group">
                <label for="email">ì´ë©”ì¼</label>
                <input type="email" id="email" name="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>

            <div class="form-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" name="password" required>
            </div>

            <div class="form-group">
                <label for="password-confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="password-confirm" name="password_confirm" required>
            </div>

            <div class="form-group">
                <label for="company_name">ì—…ì²´ëª…</label>
                <input type="text" id="company_name" name="company_name" placeholder="(ì£¼)ì—ì½”ì—ì´ì•¤ì´" required>
            </div>

            <div class="form-group">
                <label for="business_registration_number">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
                <div class="input-with-button">
                    <input type="text" id="business_registration_number" name="business_registration_number" placeholder="155-81-02947" required>
                    <button type="button" class="btn-verify" onclick="verifyBusinessNumber()">ê²€ì¦</button>
                </div>
            </div>

            <div class="form-group">
                <label for="business_phone_number">ëŒ€í‘œë²ˆí˜¸</label>
                <input type="tel" id="business_phone_number" name="business_phone_number" placeholder="042-933-4555" required>
            </div>

            <div class="form-group">
                <label for="consulting_phone_number">ìƒë‹´ë²ˆí˜¸</label>
                <input type="tel" id="consulting_phone_number" name="consulting_phone_number" placeholder="042-933-4555">
            </div>

            <div class="form-group">
                <label for="address">ì£¼ì†Œ</label>
                <div class="input-with-button">
                    <input type="text" id="address" name="address" placeholder="ëŒ€ì „ê´‘ì—­ì‹œ ìœ ì„±êµ¬ êµ­ì œê³¼í•™8ë¡œ 5(ì‹ ë™)" readonly required>
                    <button type="button" class="btn-verify" onclick="searchAddress()">ì£¼ì†Œ ì°¾ê¸°</button>
                </div>
            </div>

            <div class="form-group">
                <label for="address_detail">ë‚˜ë¨¸ì§€ ì£¼ì†Œ</label>
                <input type="text" id="address_detail" name="address_detail" placeholder="ì—ì½”ì—ì´ì•¤ì´">
            </div>

            <!-- ë¶„ì•¼ ì„ íƒ ë²„íŠ¼ (ëª¨ë‹¬ ì—´ê¸°) -->
            <div class="form-group">
                <label for="service_category">ë¶„ì•¼</label>
                <div class="category-input-container">
                    <div id="selected_categories_display" class="selected-categories">
                        <!-- Selected categories will appear here as tags -->
                    </div>
                    <button type="button" class="search-btn" onclick="openFieldModal()">ğŸ”</button>
                </div>
                <input type="hidden" id="service_category_codes" name="service_category_codes" value="">
            </div>

            <div class="form-group">
                <label for="attachment">ì²¨ë¶€íŒŒì¼</label>
                <div class="file-upload-wrapper">
                    <input type="file" 
                           id="attachment" 
                           name="attachment" 
                           accept=".jpg,.jpeg,.png,.pdf"
                           class="file-upload-input"
                           multiple
                           onchange="updateFileName(this)">
                    <span class="file-name">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</span>
                    <button type="button" class="file-upload-btn" onclick="document.getElementById('attachment').click()">íŒŒì¼ ì„ íƒ</button>
                </div>
                <p class="file-format-info">* JPG, JPEG, PNG, PDF íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥</p>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-submit">ê°€ì…ì‹ ì²­</button>
        </div>
    </form>
</div>

<!-- ë¶„ì•¼ ì„ íƒ ëª¨ë‹¬ -->
<div id="fieldModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë¶„ì•¼ ì„ íƒ</h3>
            <input type="text" id="categorySearch" placeholder="ë¶„ì•¼ ê²€ìƒ‰ (ì½”ë“œ/ì´ë¦„)" oninput="searchCategories()">
            <button type="button" class="close-btn" onclick="closeFieldModal()">Ã—</button>
        </div>
        <div class="field-categories" id="fieldCategoriesList">
            <!-- Categories dynamically added here -->
        </div>
        <div class="modal-footer">
            <button type="button" class="confirm-btn" onclick="confirmFieldSelection()">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
    const categoriesData = {{ categories|safe }};
    const selectedCategoriesDisplay = document.getElementById('selected_categories_display');
    const serviceCategoryCodesInput = document.getElementById('service_category_codes');
    const fieldCategoriesList = document.getElementById('fieldCategoriesList');

    let selectedCategories = [];

    function openFieldModal() {
        document.getElementById('fieldModal').style.display = 'block';
        displayCategories(categoriesData);
    }

    function closeFieldModal() {
        document.getElementById('fieldModal').style.display = 'none';
    }

    function displayCategories(categories) {
        fieldCategoriesList.innerHTML = '';
        categories.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category-option';
            categoryDiv.innerHTML = `
                <label>
                    <input type="checkbox" value="${category.category_code}" data-name="${category.name}" 
                           onchange="toggleCategorySelection(this)">
                    ${category.name} (${category.category_code})
                </label>
            `;
            fieldCategoriesList.appendChild(categoryDiv);
        });
    }

    function searchCategories() {
        const searchTerm = document.getElementById('categorySearch').value.toLowerCase();
        const filteredCategories = categoriesData.filter(category =>
            category.name.toLowerCase().includes(searchTerm) ||
            category.category_code.toLowerCase().includes(searchTerm)
        );
        displayCategories(filteredCategories);
    }

    function toggleCategorySelection(checkbox) {
        const categoryCode = checkbox.value;
        const categoryName = checkbox.getAttribute('data-name');

        if (checkbox.checked) {
            if (!selectedCategories.some(cat => cat.code === categoryCode)) {
                selectedCategories.push({ code: categoryCode, name: categoryName });
            }
        } else {
            selectedCategories = selectedCategories.filter(cat => cat.code !== categoryCode);
        }
        updateSelectedCategoriesDisplay();
    }

    function updateSelectedCategoriesDisplay() {
        selectedCategoriesDisplay.innerHTML = '';
        selectedCategories.forEach(category => {
            const tag = document.createElement('div');
            tag.className = 'category-tag';
            tag.innerHTML = `${category.name} <span onclick="removeCategory('${category.code}')">Ã—</span>`;
            selectedCategoriesDisplay.appendChild(tag);
        });
        serviceCategoryCodesInput.value = JSON.stringify(selectedCategories.map(cat => cat.code));
    }

    function removeCategory(code) {
        selectedCategories = selectedCategories.filter(cat => cat.code !== code);
        updateSelectedCategoriesDisplay();
    }

    function confirmFieldSelection() {
        closeFieldModal();
        updateSelectedCategoriesDisplay();
    }

    document.addEventListener('DOMContentLoaded', function() {
        closeFieldModal();
    });

    // âœ… í¼ ì œì¶œ ì „ ìœ íš¨ì„± ê²€ì‚¬ ë° API ìš”ì²­
function setupFormValidation() {
    const signupForm = document.getElementById("signupForm");

    if (!signupForm) {
        console.error("âš ï¸ signupForm ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    signupForm.addEventListener("submit", function (e) {
        e.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€

        const requiredFields = [
            "username", "email", "password", "password-confirm",
            "company_name", "business_registration_number",
            "business_phone_number", "address"
        ];

        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value.trim()) {
                showAlert(`${fieldId.replace("_", " ")}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                return;
            }
        }

        if (document.getElementById("password").value !== document.getElementById("password-confirm").value) {
            showAlert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        const formData = new FormData(signupForm);
        const jsonData = Object.fromEntries(formData.entries());

        console.log("ğŸ“Œ íšŒì›ê°€ì… ìš”ì²­ ë°ì´í„°:", jsonData);

        fetch("{% url 'provider_signup' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify(jsonData),
        })
        .then(response => {
            console.log("ğŸ“Œ ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);
            
            if (data.success && data.redirect_url) {
                console.log("âœ… íšŒì›ê°€ì… ì„±ê³µ! í˜ì´ì§€ ì´ë™:", data.redirect_url);
                window.location.href = data.redirect_url;
            } else {
                console.error("âŒ íšŒì›ê°€ì… ì‹¤íŒ¨:", data.error);
                showAlert(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        })
        .catch(error => {
            console.error("ğŸš¨ íšŒì›ê°€ì… ìš”ì²­ ì˜¤ë¥˜:", error);
            showAlert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        });
    });
}
</script>

<style>
    /* ë¶„ì•¼ ì„ íƒ ê²€ìƒ‰ UI ìŠ¤íƒ€ì¼ */
.category-input-container {
    display: flex;
    align-items: center;
    border: 1px solid #ccc;
    padding: 8px;
    border-radius: 4px;
    min-height: 40px;
}

.selected-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    flex-grow: 1;
}

.category-tag {
    display: flex;
    align-items: center;
    background-color: #3B82F6;
    color: white;
    border-radius: 15px;
    padding: 5px 10px;
    font-size: 14px;
}

.category-tag span {
    margin-left: 8px;
    cursor: pointer;
    font-weight: bold;
}

.search-btn {
    background: #3B82F6;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.search-btn:hover {
    background: #2563EB;
}

/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

.modal-content {
    background: white;
    width: 400px;
    padding: 20px;
    margin: 10% auto;
    border-radius: 8px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header input {
    flex-grow: 1;
    padding: 5px;
    margin-left: 10px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

.field-categories {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
}

.category-option {
    padding: 5px;
    border-bottom: 1px solid #ddd;
}

</style>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    function checkIdDuplicate() {
        const username = document.getElementById("username").value;
        if (!username) {
            alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch("{% url 'check_id' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            },
            body: JSON.stringify({ id: username }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_duplicate) {
                alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.");
            } else {
                alert("ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.");
            }
        })
        .catch(error => {
            console.error("ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜:", error);
            alert("ì•„ì´ë”” í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }

    function verifyBusinessNumber() {
        const businessNumber = document.getElementById("business_registration_number").value;
        if (!businessNumber) {
            alert("ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch("{% url 'verify_business_number' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            },
            body: JSON.stringify({ business_number: businessNumber }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_valid) {
                alert("ìœ íš¨í•œ ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ì…ë‹ˆë‹¤.");
            } else {
                alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ì…ë‹ˆë‹¤.");
            }
        })
        .catch(error => {
            console.error("ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ê²€ì¦ ì˜¤ë¥˜:", error);
            alert("ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }

    function searchAddress() {
        new daum.Postcode({
            oncomplete: function (data) {
                document.getElementById("address").value = data.roadAddress;
                document.getElementById("address_detail").focus();
            },
        }).open();
    }

    function updateFileName(input) {
        const fileNames = Array.from(input.files).map(file => file.name).join(', ');
        input.nextElementSibling.textContent = fileNames;
    }

// í¼ ì œì¶œ ì „ ìœ íš¨ì„± ê²€ì‚¬ ë¶€ë¶„ì„ ìˆ˜ì •
document.querySelector('.signup-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // í•„ìˆ˜ í•„ë“œ ê²€ì‚¬
    const requiredFields = [
        'username', 'email', 'password', 'password-confirm',
        'company_name', 'business_registration_number',
        'business_phone_number', 'address'
    ];

    for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        const labelElement = field.closest('.form-group').querySelector('label'); // âœ… ìˆ˜ì •: label ìš”ì†Œ ì°¾ê¸°

        if (!field.value.trim()) {
            const labelText = labelElement ? labelElement.textContent : 'í•„ìˆ˜ í•„ë“œ'; // âœ… label ìš”ì†Œê°€ ì—†ì„ ê²½ìš° ëŒ€ë¹„
            showAlert(`${labelText}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`);
            field.focus();
            return;
        }
    }

    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (document.getElementById('password').value !== 
        document.getElementById('password-confirm').value) {
        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    // í¼ ì œì¶œ
    this.submit();
});

function showAlert(message, type = 'error') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 4px;
        z-index: 1000;
        background-color: ${type === 'error' ? '#f8d7da' : '#d4edda'};
        color: ${type === 'error' ? '#721c24' : '#155724'};
        border: 1px solid ${type === 'error' ? '#f5c6cb' : '#c3e6cb'};
    `;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>

{% endblock %}