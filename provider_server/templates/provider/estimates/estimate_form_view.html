{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<!-- CSRF í† í°ì„ ìˆ¨ê²¨ì§„ inputìœ¼ë¡œ ì¶”ê°€ -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="estimate-form-container">
    <div class="main-title">
        <h2>ê²¬ì ì„œ ì¡°íšŒ</h2>
        <span class="subtitle">ê²¬ì ì„œ ID: {{ estimate.estimate_request_id }}</span>
    </div>

    <div class="estimate-form-wrapper">
        <!-- ìƒë‹¨ ë²„íŠ¼ ê·¸ë£¹ -->
        <div class="action-buttons">
            {% if estimate.status != 'SENT' %}
                <button onclick="editEstimate()" class="btn btn-primary">ìˆ˜ì •í•˜ê¸°</button>
                <button onclick="sendEstimate('{{ estimate.estimate_request_id }}')" class="btn btn-success">ê²¬ì ì„œ ë°œì†¡</button>
            {% endif %}
        </div>

        <!-- ìˆ˜ìš”ì(ê³ ê°) ì •ë³´ ì„¹ì…˜ -->
        <div class="customer-info-section">
            <h3>ìˆ˜ìš”ì(ê³ ê°) ì •ë³´</h3>
            <div class="customer-stats">
                <div class="stat-item">
                    <label>ìµœì´ˆê°€ì…ì¼</label>
                    <span>{{ customer.joined_at|date:"Y.m.d" }}</span>
                </div>
                <div class="stat-item">
                    <label>ì´ìš©íšŸìˆ˜</label>
                    <span>{{ customer.usage_count }}íšŒ</span>
                </div>
                <div class="stat-item">
                    <label>ì£¼ìš”ì§€ì—­</label>
                    <span>{{ customer.region }}</span>
                </div>
            </div>
            <div class="customer-request">
                <h4>ìš”ì²­ì‚¬í•­</h4>
                <div class="request-content">
                    {{ original_request.request_details|linebreaks }}
                </div>
            </div>
        </div>

        <div class="estimate-form" data-estimate-id="{{ estimate.estimate_request_id }}">
            <!-- ê²¬ì ì„œ ë‚´ìš© -->
        <div class="estimate-content">
            <h2 class="estimate-title">ê²¬ì ì„œ_(ì£¼){{ original_request.contact_name }} ê³ ê°ë‹˜.</h2>
            
            <!-- ê²¬ì  ì •ë³´ ê·¸ë¦¬ë“œ -->
            <div class="info-grid">
                <!-- ì˜ë¢°ì¸ ì •ë³´ -->
                <div class="info-section">
                    <h3>ì˜ë¢°ì¸ ì •ë³´</h3>
                    <table class="info-table">
                        <tr>
                            <th>ê²¬ì  ì‹ ì²­ì¼</th>
                            <td>{{ original_request.created_at|date:"Y.m.d(ì¼) H:i" }}</td>
                        </tr>
                        <tr>
                            <th>ê²¬ì  ì˜ë¢°ì¸</th>
                            <td>{{ original_request.contact_name }}</td>
                        </tr>
                        <tr>
                            <th>ì—°ë½ì²˜</th>
                            <td>{{ original_request.contact_phone }}</td>
                        </tr>
                        <tr>
                            <th>ì´ë©”ì¼</th>
                            <td>{{ original_request.contact_email }}</td>
                        </tr>
                        <tr>
                            <th>í˜„ì¥ ì£¼ì†Œ</th>
                            <td>{{ original_request.address }}</td>
                        </tr>
                    </table>
                </div>

                <!-- ì¸¡ì •ì—…ì²´ ì •ë³´ -->
                <div class="info-section">
                    <h3>ì¸¡ì •ì—…ì²´ ì •ë³´</h3>
                    <table class="info-table">
                        <tr>
                            <th>ê²¬ì  ì‘ì„±ì¼</th>
                            <td>{{ estimate.created_at|date:"Y.m.d(ì¼) H:i" }}</td>
                        </tr>
                        <tr>
                            <th>ê²¬ì  ì‘ì„±ì¸</th>
                            <td>{{ estimate.writer_name }}</td>
                        </tr>
                        <tr>
                            <th>ì´ë©”ì¼</th>
                            <td>{{ estimate.writer_email }}</td>
                        </tr>
                        <tr>
                            <th>â€»</th>
                            <td>ê²¬ì ì€ ì‚¬ì •ì— ë”°ë¼ ì¶”í›„ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- ì¸¡ì • í•­ëª© í…Œì´ë¸” -->
            <div class="measurement-section">
                <div class="section-header">
                    <h3>ì¸¡ì • í•­ëª©</h3>
                    <span>ë‹¨ìœ„ : ì›</span>
                </div>
                <div class="measurement-items">
                    {% for category in original_request.service_categories %}
                    <div class="measurement-item">
                        <div class="form-row">
                            <div class="form-group item-name">
                                <label>ì¸¡ì • ì¢…ë¥˜ {{ forloop.counter }}</label>
                                <p>{{ category.name }}</p>
                            </div>
                            <div class="form-group qty">
                                <label>ìœ ì§€ ì§€ì ìˆ˜</label>
                                <p>{{ estimate.maintain_points|default:"0"|intcomma }}</p>
                            </div>
                            <div class="form-group qty">
                                <label>ê¶Œê³  ì§€ì ìˆ˜</label>
                                <p>{{ estimate.recommend_points|default:"0"|intcomma }}</p>
                            </div>
                            <div class="form-group price">
                                <label>ë‹¨ê°€</label>
                                <p>{{ estimate.unit_price|default:"0"|intcomma }}ì›</p>
                            </div>
                            <div class="form-group subtotal">
                                <label>ì†Œê³„</label>
                                <p class="amount">{{ estimate.total_amount|default:"0"|intcomma }}ì›</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ê²¬ì  ì„¤ëª… -->
            {% if estimate.notes %}
            <div class="estimate-description">
                <h3>ê²¬ì  ì„¤ëª…</h3>
                <div class="description-content">
                    {{ estimate.notes|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- ê¸ˆì•¡ ì •ë³´ -->
            <div class="price-section">
                <div class="price-row">
                    <span>ê³µê¸‰ê°€ì•¡</span>
                    <span class="amount">{{ estimate.base_amount|floatformat:0 }}ì›</span>
                </div>
                <div class="price-row">
                    <span>í• ì¸</span>
                    <span class="amount discount">{{ estimate.discount_amount|floatformat:0 }}ì›</span>
                </div>
                <div class="price-row">
                    <span>ë¶€ê°€ì„¸</span>
                    <span class="amount">{{ estimate.vat_amount|floatformat:0 }}ì›</span>
                </div>
                <div class="price-row total">
                    <span>ìµœì¢… í•©ê³„</span>
                    <span class="amount">{{ estimate.total_amount|floatformat:0 }}ì›</span>
                </div>
            </div>

            <!-- í•˜ë‹¨ ì„œëª… ì˜ì—­ -->
            <div class="signature-section">
                <p class="signature-text">(ì£¼){{ estimate.customer_name }} ê³ ê°ë‹˜ì„ ìœ„í•œ ê²¬ì ì„ ë‹¤ìŒê³¼ ê°™ì´ ì œì•ˆí•©ë‹ˆë‹¤.</p>
                <div class="company-stamp">
                    <p class="company-name">(ì£¼)ì¸¡ì •í•˜ëŠ”ì—…ì²´</p>
                    <div class="stamp-image">
                        <!-- ë„ì¥ ì´ë¯¸ì§€ -->
                    </div>
                    <p class="date">{{ estimate.updated_at|date:"Y.m.d" }}</p>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<style>
/* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
.estimate-form-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    background-color: #fff;
}

/* íƒ€ì´í‹€ */
.main-title {
    display: flex;
    align-items: center;
    font-size: 24px;
    color: #333;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #eee;
}

.subtitle {
    margin-left: 1rem;
    font-size: 16px;
    color: #666;
}

/* ë²„íŠ¼ ê·¸ë£¹ */
.action-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-bottom: 2rem;
}

.btn {
    padding: 8px 24px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: none;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-success {
    background-color: #28a745;
    color: white;
}

/* ê²¬ì ì„œ ë‚´ìš© */
.estimate-content {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    padding: 2rem;
}

.estimate-title {
    font-size: 20px;
    color: #333;
    margin-bottom: 2rem;
}

/* ì •ë³´ ê·¸ë¦¬ë“œ */
.info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    margin-bottom: 2rem;
}

.info-section {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
}

.info-section h3 {
    font-size: 16px;
    color: #333;
    margin-bottom: 1rem;
}

.info-table {
    width: 100%;
    border-collapse: collapse;
}

.info-table th,
.info-table td {
    padding: 12px;
    border: 1px solid #dee2e6;
}

.info-table th {
    background-color: #f8f9fa;
    width: 30%;
    text-align: left;
    font-weight: 500;
    color: #495057;
}

/* ì¸¡ì • í•­ëª© ì„¹ì…˜ */
.measurement-section {
    margin: 2rem 0;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-header h3 {
    font-size: 16px;
    color: #333;
}

.measurement-items {
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
}

.measurement-item {
    padding: 1.5rem;
    border-bottom: 1px solid #dee2e6;
}

.measurement-item:last-child {
    border-bottom: none;
}

.form-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1.5fr 1.5fr;
    gap: 1rem;
    align-items: center;
}

.form-group label {
    display: block;
    color: #666;
    margin-bottom: 0.5rem;
    font-size: 14px;
}

.form-group p {
    margin: 0;
    font-size: 15px;
    color: #333;
}

/* ê²¬ì  ì„¤ëª… */
.estimate-description {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 2rem 0;
}

.estimate-description h3 {
    font-size: 16px;
    color: #333;
    margin-bottom: 1rem;
}

.description-content {
    color: #495057;
    line-height: 1.6;
}

/* ê¸ˆì•¡ ì •ë³´ */
.price-section {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 2rem;
}

.price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #dee2e6;
}

.price-row:last-child {
    border-bottom: none;
}

.price-row.total {
    font-weight: bold;
    color: #007bff;
}

.amount {
    font-family: monospace;
    font-size: 16px;
    text-align: right;
}

.discount {
    color: #dc3545;
}

/* ì„œëª… ì˜ì—­ */
.signature-section {
    text-align: center;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #dee2e6;
}

.signature-text {
    color: #495057;
    margin-bottom: 2rem;
}

.company-stamp {
    display: inline-block;
}

.company-name {
    font-weight: bold;
    margin-bottom: 1rem;
}

.stamp-image {
    width: 100px;
    height: 100px;
    margin: 1rem auto;
    border: 1px solid #dee2e6;
    border-radius: 50%;
}

.date {
    color: #666;
    margin-top: 1rem;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .info-grid {
        grid-template-columns: 1fr;
    }

    .form-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }

    .action-buttons {
        flex-direction: column;
    }

    .btn {
        width: 100%;
    }
}
</style>
<script>
    const COMMON_API_URL = "{{ common_api_url }}";  // Djangoì—ì„œ ì „ë‹¬í•œ API URL
</script>
<script>

async function editEstimate() {
    if (!confirm('ê²¬ì ì„œë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const estimateId = '{{ estimate.estimate_request_id }}';
    window.location.href = `/estimate_list/estimates/received/${estimateId}/update/`;
}

async function sendEstimate(estimateId) {
    if (!confirm('ê²¬ì ì„œë¥¼ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        console.log("ë°œì†¡í•  ê²¬ì  ID:", estimateId);

        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        const csrfTokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (!csrfTokenElement) {
            throw new Error('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        const csrfToken = csrfTokenElement.value;

        // ìš”ì²­ ì‹¤í–‰
        const response = await fetch(`${COMMON_API_URL}/estimates/estimates/${estimateId}/send/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        // ğŸš¨ ì‘ë‹µì´ JSONì´ ì•„ë‹ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë¯€ë¡œ í™•ì¸ í›„ ì²˜ë¦¬
        let data;
        if (response.headers.get('content-type')?.includes('application/json')) {
            data = await response.json();
        } else {
            const text = await response.text();
            console.error('ì„œë²„ ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹˜:', text);
            throw new Error('ì„œë²„ ì˜¤ë¥˜: ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
        if (!response.ok) {
            throw new Error(data.error || `ê²¬ì ì„œ ë°œì†¡ ì‹¤íŒ¨ (HTTP ${response.status})`);
        }

        alert('âœ… ê²¬ì ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        window.location.href = `/estimate_list/estimates/received/${estimateId}/view/`;

    } catch (error) {
        console.error('ğŸš¨ ê²¬ì  ë°œì†¡ ì˜¤ë¥˜:', error);
        alert(`âŒ ê²¬ì  ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    }
}


// CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getCsrfToken() {
    const token = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (!token) {
        throw new Error('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    return token.value;
}
</script>
{% endblock %}