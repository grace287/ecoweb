{% extends 'base.html' %}
{% load static %}

{% block title %}견적 요청 목록 - EcoAnE{% endblock %}

{% block content %}
<div class="estimates-container">
    <h2 class="page-title">견적요청 목록</h2>
    
    <!-- 상태 필터 추가 -->
    <div class="status-filter">
        <select id="statusFilter" class="form-select">
            <option value="">전체 상태</option>
            <option value="REQUEST">요청</option>
            <option value="RESPONSE">응답</option>
            <option value="APPROVED">승인</option>
            <option value="REJECTED">거절</option>
        </select>
    </div>
    
    <div class="estimates-table">
        <table>
            <thead>
                <tr>
                    <th>순번</th>
                    <th>서비스</th>
                    <th>장소</th>
                    <th>상태</th>
                    <th>견적금액</th>
                    <th>제공자</th>
                    <th>요청일</th>
                    <th>조회수</th>
                </tr>
            </thead>
            <tbody id="estimateList">
                {% if estimates %}
                    {% for estimate in estimates %}
                    <tr class="estimate-row" data-id="{{ estimate.id }}">
                        <td>{{ estimate.id }}</td>
                        <td>
                            {% if estimate.service_categories %}
                                {{ estimate.service_categories.0.name }}
                            {% else %}
                                미지정
                            {% endif %}
                        </td>
                        <td>
                            {% if estimate.measurement_locations %}
                                {{ estimate.measurement_locations.0.name }}
                            {% else %}
                                미지정
                            {% endif %}
                        </td>
                        <td class="status-{{ estimate.status|lower }}">{{ estimate.status }}</td>
                        <td>{{ estimate.total_amount|default:"미정" }}</td>
                        <td>{{ estimate.provider_info.name|default:"미정" }}</td>
                        <td>{{ estimate.created_at|date:"Y-m-d" }}</td>
                        <td>{{ estimate.views|default:"0" }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="no-data">견적 요청 내역이 없습니다.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- 페이지네이션 -->
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1">처음</a>
            <a href="?page={{ page_obj.previous_page_number }}">이전</a>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <strong>{{ num }}</strong>
            {% else %}
                <a href="?page={{ num }}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">다음</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">마지막</a>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 상태 필터 변경 이벤트
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            fetchEstimates(this.value);
        });
    }

    // 견적 행 클릭 이벤트
    const rows = document.querySelectorAll('.estimate-row');
    rows.forEach(row => {
        row.addEventListener('click', function() {
            const estimateId = this.dataset.id;
            window.location.href = `/estimates/received/${estimateId}/`;
        });
    });

    // 견적 목록 조회 함수
    async function fetchEstimates(status = '') {
        try {
            const response = await fetch(`/estimates/received/?status=${status}`, {
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('견적 목록 조회 실패');
            }

            const data = await response.json();
            updateEstimateList(data.estimates);

        } catch (error) {
            console.error('견적 목록 조회 중 오류:', error);
        }
    }

    // 견적 목록 업데이트 함수
    function updateEstimateList(estimates) {
        const tbody = document.getElementById('estimateList');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (estimates && estimates.length > 0) {
            estimates.forEach(estimate => {
                const tr = document.createElement('tr');
                tr.className = 'estimate-row';
                tr.dataset.id = estimate.id;

                tr.innerHTML = `
                    <td>${estimate.id}</td>
                    <td>${estimate.service_categories ? estimate.service_categories[0].name : '미지정'}</td>
                    <td>${estimate.measurement_locations ? estimate.measurement_locations[0].name : '미지정'}</td>
                    <td class="status-${estimate.status.toLowerCase()}">${estimate.status}</td>
                    <td>${estimate.total_amount || '미정'}</td>
                    <td>${estimate.provider_info ? estimate.provider_info.name : '미정'}</td>
                    <td>${new Date(estimate.created_at).toLocaleDateString()}</td>
                    <td>${estimate.views || 0}</td>
                `;

                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="no-data">견적 요청 내역이 없습니다.</td>
                </tr>
            `;
        }
    }
});
</script>

<style>
/* 기존 스타일 유지 */
.status-filter {
    margin-bottom: 20px;
    text-align: right;
}

.form-select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-width: 150px;
}

/* 상태별 색상 */
.status-request { color: #6c757d; }
.status-response { color: #17a2b8; }
.status-approved { color: #28a745; }
.status-rejected { color: #dc3545; }

.estimate-row {
    cursor: pointer;
}

.estimate-row:hover {
    background-color: #f8f9fa;
}

.no-data {
    text-align: center;
    padding: 20px;
    color: #6c757d;
}
</style>
{% endblock %}