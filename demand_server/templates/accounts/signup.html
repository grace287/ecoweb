{% extends 'base.html' %}
{% load static %}


{% block content %}
<link rel="stylesheet" href="{% static 'css/accounts/signup.css' %}">

<div class="signup-container">
    <h1>íšŒì› ê°€ì…</h1>
    
    <!-- ì§„í–‰ ë‹¨ê³„ í‘œì‹œ -->
    <div class="signup-progress">
        <div class="progress-step active">
            <div class="step-icon"><img src="{% static 'img/components/signup/user-icon.png' %}" alt=""></div>
            <span>STEP 1</span><p>ê¸°ë³¸ì •ë³´ ì…ë ¥</p>
        </div>
        <div class="progress-step">
            <div class="step-icon"><img src="{% static 'img/components/signup/doc-icon.png' %}" alt=""></div>
            <span>STEP 2</span><p>ì¶”ê°€ì •ë³´ ì…ë ¥</p>
        </div>
        <div class="progress-step">
            <div class="step-icon"><img src="{% static 'img/components/signup/check-icon.png' %}" alt=""></div>
            <span>STEP 3</span><p>ê°€ì… ì™„ë£Œ</p>
        </div>
    </div>

    <form class="signup-form" action="{% url 'signup' %}">
        {% csrf_token %}

        <!-- 1ë‹¨ê³„: ê¸°ë³¸ ì •ë³´ -->
        <section class="form-section">
            <h3>ê¸°ë³¸ ì •ë³´</h3>
            <div class="form-group">
                <label for="username">ì•„ì´ë””</label>
                <div class="input-with-button">
                    <input type="text" id="username" name="username" required>
                <button type="button" class="verify-btn" onclick="checkDuplicate('username')">ì¤‘ë³µí™•ì¸</button>
                </div>
                
            </div>

            <div class="form-group">
                <label for="email">ì´ë©”ì¼</label>
                <div class="input-with-button">
                    <input type="email" id="email" name="email" required>
                    <button type="button" class="verify-btn" onclick="checkDuplicate('email')">ì¤‘ë³µí™•ì¸</button>
                </div>
            </div>

            <div class="form-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" name="password" required>
            </div>

            <div class="form-group">
                <label for="password_confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="password_confirm" name="password_confirm" required>
            </div>
        </section>

        <!-- 2ë‹¨ê³„: ì¶”ê°€ ì •ë³´ -->
        <section class="form-section">
            <h3>ì¶”ê°€ ì •ë³´</h3>
            <div class="form-group">
                <label for="company_name">ì—…ì²´ëª…</label>
                <input type="text" id="company_name" name="company_name" required>
            </div>

            <div class="form-group">
                <label for="business_phone_number">ë‹´ë‹¹ì íœ´ëŒ€í° ë²ˆí˜¸</label>
                <input type="tel" id="business_phone_number" name="business_phone_number" required>
            </div>

            <div class="form-group">
                <label for="address">ì£¼ì†Œ</label>
                <div class="input-with-button">
                    <input type="text" id="address" name="address" readonly required>
                    <button type="button" class="address-search-btn" onclick="searchAddress()">ì£¼ì†Œ ì°¾ê¸°</button>
                </div>
            </div>

            <div class="form-group">
                <label for="address_detail">ìƒì„¸ ì£¼ì†Œ</label>
                <input type="text" id="address_detail" name="address_detail" placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥">
            </div>
        </section>

        <section class="form-section">
            <h3>ì¶”ê°€ ì •ë³´</h3>
            
            <div class="form-group">
                <label for="recommend">ì¶”ì²œì¸ ì•„ì´ë””</label>
                <div class="input-with-button">
                    <input type="text" id="recommend" name="recommend">
                    <button type="button" class="verify-btn" onclick="checkRecommendId()">ì•„ì´ë”” í™•ì¸</button>
                </div>
            </div>

            <div class="notice-box">
                <h4>í”Œë«í¼ ì•ˆë‚´ ì´ë²¤íŠ¸!</h4>
                <ol>
                    <li>ì¶”ì²œì¸ ì•„ì´ë””ë¥¼ ë‚¨ê²¨ì£¼ì‹œë©´ ì‹ ê·œíšŒì› 10% í• ì¸ ì¿ í° ì¦ì •</li>
                    <li>ì‹ ê·œíšŒì›ê°€ ì›°ì»´íŒ¨í‚¤ì§€(5ë§Œì› ì¿ í°ë¶ ì¶”ê°€ ì¦ì •)</li>
                </ol>
            </div>
        </section>

        <button type="submit" class="submit-btn">ê°€ì…í•˜ê¸°</button>
    </form>
</div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")?.value;
    const signupForm = document.querySelector(".signup-form");

    if (!signupForm || !csrfToken) {
        console.error("Signup form or CSRF token not found.");
        return;
    }

    signupForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const requiredFields = ["username", "email", "password", "password_confirm", "company_name", "business_phone_number", "address"];
        let missingFields = [];

        requiredFields.forEach(field => {
            const input = document.getElementById(field);
            if (!input.value.trim()) {
                missingFields.push(field);
                input.style.border = "2px solid red";  // UI ê°œì„  (ë¹ˆ í•„ë“œ ê°•ì¡°)
            } else {
                input.style.border = "";  // ì •ìƒ ì…ë ¥ ì‹œ ì›ë˜ ìŠ¤íƒ€ì¼ ë³µì›
            }
        });

        if (missingFields.length > 0) {
            alert(`ğŸš¨ í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”: ${missingFields.join(", ")}`);
            return;
        }

        const formData = new FormData(this);
        const jsonData = Object.fromEntries(formData.entries()); // âœ… JSON ë³€í™˜

        console.log("ğŸ“Œ ì „ì†¡í•  JSON ë°ì´í„°:", jsonData); // âœ… ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
        const csrfToken = getCookie('csrftoken');

        try {
            const response = await fetch(this.action, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify(jsonData),
                credentials: "include", // â˜… í•„ìˆ˜
            });

            

            if (!response.ok) {
                const errorText = await response.text();
                console.error("ğŸ“Œ ì„œë²„ ì˜¤ë¥˜ ì‘ë‹µ:", errorText);
                throw new Error(errorText);
            }

            const data = await response.json();
            console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ:", data); // âœ… ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

            if (data.success) {
                window.location.href = data.redirect_url; // âœ… ì˜¬ë°”ë¥¸ URLë¡œ ì´ë™
            } else {
                alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + (data.error || JSON.stringify(data.errors)));
            }
        } catch (error) {
            console.error("Signup error:", error);
            alert("íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });

    /** âœ… ë‹¨ê³„ ì´ë™ ê¸°ëŠ¥ */
    let currentStep = 1;
    function showStep(step) {
        document.querySelectorAll(".form-section").forEach((section, index) => {
            section.style.display = index + 1 === step ? "block" : "none";
        });

        document.querySelectorAll(".progress-step").forEach((stepElement, index) => {
            stepElement.classList.toggle("active", index + 1 <= step);
        });

        currentStep = step;
    }

    window.nextStep = () => {
        if (currentStep < 2) showStep(currentStep + 1);
    };

    window.prevStep = () => {
        if (currentStep > 1) showStep(currentStep - 1);
    };

    /** âœ… ì£¼ì†Œ ê²€ìƒ‰ */
    window.searchAddress = function () {
        new daum.Postcode({
            oncomplete: function (data) {
                document.getElementById("address").value = data.roadAddress;
                document.getElementById("address_detail").focus();
            },
        }).open();
    };

    /** âœ… ì¤‘ë³µ í™•ì¸ (ì•„ì´ë””, ì´ë©”ì¼) */
    window.checkDuplicate = async function (type) {
        const inputField = document.getElementById(type);
        if (!inputField) {
            alert(`${type === "username" ? "ì•„ì´ë””" : "ì´ë©”ì¼"} ì…ë ¥ë€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        const value = inputField.value.trim();
        if (!value) {
            alert(`${type === "username" ? "ì•„ì´ë””" : "ì´ë©”ì¼"}ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
            return;
        }

        try {
            const response = await fetch(`/check-${type}-duplicate/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({ [type]: value }),
            });

            const data = await response.json();
            if (data.is_duplicate) {
                alert(`âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ${type === "username" ? "ì•„ì´ë””" : "ì´ë©”ì¼"}ì…ë‹ˆë‹¤.`);
                inputField.style.border = "2px solid red"; // UI ê°œì„ 
            } else {
                alert(`âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ${type === "username" ? "ì•„ì´ë””" : "ì´ë©”ì¼"}ì…ë‹ˆë‹¤.`);
                inputField.style.border = "2px solid green"; // UI ê°œì„ 
            }
        } catch (error) {
            console.error(`${type} ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜:`, error);
            alert(`${type === "username" ? "ì•„ì´ë””" : "ì´ë©”ì¼"} í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
        }
    };
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

{% endblock %}