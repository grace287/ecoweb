{% load static %}
{% load socialaccount %}

<link rel="stylesheet" href="{% static 'css/accounts/login.css' %}">

{% block extra_js %}{% endblock %}

{% block content %}

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div class="login-container">
            <h2>EcoAnE</h2>
            <form method="post" class="login-form" action="{% url 'login' %}">
                {% csrf_token %}
                <input type="text" name="username" placeholder="ì•„ì´ë”” ì…ë ¥" required>
                <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required>
                <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
            </form>

        

            <div class="error-message" style="display: none; color: red;"></div>
            <div class="social-login">
                <a href="#">
                    <img src="{% static 'img/components/login/google-login-img.png' %}" alt="êµ¬ê¸€ ë¡œê·¸ì¸">
                </a>
                <a href="#">
                    <img src="{% static 'img/components/login/kakao-login-img.png' %}" alt="ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸">
                </a>
                <a href="#">
                    <img src="{% static 'img/components/login/naver-login-img.png' %}" alt="ë„¤ì´ë²„ ë¡œê·¸ì¸">
                </a>
            </div>
            <div class="login-links">
                <span>ê°€ì…ë§Œ í•˜ë©´ ë¬´ë£Œ ê²¬ì ì„ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆì–´ìš”!</span>
                <a href="{% url 'signup' %}" class="btn btn-signup">íšŒì›ê°€ì…</a>
            </div>
        </div>
    </div>
</div>

     <!-- âœ… ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
     <div id="login-success-message" style="display: none; margin-top: 15px; color: green; font-weight: bold;">
        ğŸ‰ ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!
    </div>

    <div class="error-message" style="display: none; color: red;"></div>
    ...
</div>

<!-- ë¡œê·¸ì¸ fetch -->

<script>
    document.getElementById("login-form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const response = await fetch("/login/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCsrfToken(),
    },
    body: JSON.stringify({ username, password }),
    credentials: "include",  // âœ… ì„¸ì…˜ ì¿ í‚¤ ë³´ë‚´ê¸°
  });

  const data = await response.json();

  if (data.success) {
    window.location.href = data.redirect_url;
  } else {
    alert(data.errors?.non_field_errors?.[0] || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
  }
});

</script>

<script>
    function openModal() {
        document.getElementById('login-modal').style.display = 'block';
    }
    
    function closeModal() {
        document.getElementById('login-modal').style.display = 'none';
    }
    
    document.querySelector('.close-btn').addEventListener('click', closeModal);
    
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('login-modal');
        if (event.target === modal) {
            closeModal();
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.querySelector('.login-form');
        
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            
            try {
                submitButton.disabled = true;
                submitButton.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                
                const response = await fetch('/login/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
    
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.error);  // ì„œë²„ì—ì„œ ë°˜í™˜í•˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ alertë¡œ í‘œì‹œ
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ë¡œê·¸ì¸';
            }
        });
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
    

<!-- ë¡œê·¸ì¸ì„±ê³µ -->
<script>
    if (data.success) {
    const successMsg = document.getElementById("login-success-message");
    successMsg.style.display = "block";
    successMsg.textContent = "ğŸ‰ ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!";
    
    // 1.5ì´ˆ ë’¤ ë¦¬ë””ë ‰ì…˜
    setTimeout(() => {
        window.location.href = data.redirect_url;
    }, 1500);
} else {
    alert(data.errors?.non_field_errors?.[0] || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
}

</script>

<style>
    #login-success-message {
    padding: 10px;
    background-color: #e6f4ea;
    border: 1px solid #b2dfdb;
    border-radius: 6px;
    font-size: 14px;
    color: #2e7d32;
    text-align: center;
    transition: all 0.3s ease-in-out;
}

</style>
{% endblock %}